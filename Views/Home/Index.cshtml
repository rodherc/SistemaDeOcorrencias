@page
@using SistemaDeOcorrencias.Enum
@model List<Ocorrencia>
@{
    var pagina = ViewBag.PaginaAtual;
    var totalPaginas = ViewBag.TotalPaginas;
    var colunaFiltro = ViewBag.ColunaFiltroOptions;
    var condicaoNumericaOptions = ViewBag.CondicaoNumericaOptions;
}

<link rel="stylesheet" href="~/css/Index.css" />
<h1>Visão Geral</h1>

<table id="tabelaOcorrencias" class="table table-striped table-responsive">
    <thead>
        <tr class="text-center">
            <th><input type="checkbox"></th>
            <th>Ocorrência</th>
            <th>Tipo de Ocorrência</th>
            <th>Ocorreu em / Agendado para</th>
            <th>Transportador</th>
            <th>Transportador CNPJ/CPF</th>
            <th>Solução</th>
            <th>Já Solucionada</th>
            <th>Dias em Aberto</th>
            <th></th>
        </tr>
    </thead>
    <tbody class="text-center">
    </tbody>
</table>

<nav aria-label="Paginação" class="d-flex justify-content-between">

    <ul id="pagination" class="pagination justify-content-start">
    </ul>

    <span class="text-right" id="totalRegistros">
    </span>
</nav>

<div class="mt-3">
    <div class="row g-2 align-items-center">
        <div class="col-auto">
            <select id="selectColuna1" class="form-select" onchange="toggleFiltros(this.value, 1)">
                <option value="">Selecionar...</option>
                @foreach (EnumColunaFiltro coluna in Enum.GetValues(typeof(EnumColunaFiltro)))
                {
                    <option value="@coluna.ToString()">@EnumExtensions.GetDisplayName(coluna)</option>
                }
            </select>
        </div>
        <div class="col-auto">
            <select id="selectNumerico1" class="form-select">
                @foreach (SelectListItem item in ViewBag.CondicaoNumericaOptions)
                {
                    <option value="@item.Value">@item.Text</option>
                }
            </select>
        </div>
        <div class="col-auto">
            <i class="fas fa-trash-alt fa-lg text-black-50" style="cursor: pointer;" onclick="limparFiltros(1)"></i>
        </div>
        <div class="col-12 mt-2">
            <input type="text" id="inputBusca1" class="form-control" style="display: none; width: 30%">
        </div>
    </div>
    <div class="row mt-2" id="botoesDataHora1" style="display: none;">
        <div class="col-auto">
            <button type="button" id="ontem1" class="btn btn-mini btn-outline-secondary" onclick="selecionarData('ontem', 1)">Ontem</button>
        </div>
        <div class="col-auto">
            <button type="button" id="hoje1" class="btn btn-mini btn-outline-secondary" onclick="selecionarData('hoje', 1)">Hoje</button>
        </div>
        <div class="col-auto">
            <button type="button" id="amanha1" class="btn btn-mini btn-outline-secondary" onclick="selecionarData('amanha', 1)">Amanhã</button>
        </div>
        <div class="col-auto">
            <button type="button" id="fixo1" class="btn btn-mini btn-outline-secondary" onclick="mostrarCamposDataHora(1)">Fixo</button>
        </div>
    </div>
    <div class="row mt-2 d-none" id="camposDataHora1">
        <div class="col-auto">
            <input type="date" id="dataFixo1" class="form-control">
        </div>
        <div class="col-auto">
            <input type="time" id="horaFixa1" class="form-control">
        </div>
    </div>
</div>

<div class="mt-3">
    <div class="row g-2 align-items-center">
        <div class="col-auto">
            <select id="selectColuna2" class="form-select" onchange="toggleFiltros(this.value, 2)">
                <option value="">Selecionar...</option>
                @foreach (EnumColunaFiltro coluna in Enum.GetValues(typeof(EnumColunaFiltro)))
                {
                    <option value="@coluna.ToString()">@EnumExtensions.GetDisplayName(coluna)</option>
                }
            </select>
        </div>
        <div class="col-auto">
            <select id="selectNumerico2" class="form-select">
                @foreach (SelectListItem item in ViewBag.CondicaoNumericaOptions)
                {
                    <option value="@item.Value">@item.Text</option>
                }
            </select>
        </div>
        <div class="col-auto">
            <i class="fas fa-trash-alt fa-lg text-black-50" style="cursor: pointer;" onclick="limparFiltros(2)"></i>
        </div>
        <div class="col-12 mt-2">
            <input type="text" id="inputBusca2" class="form-control" style="display: none; width: 30%">
        </div>
    </div>
    <div class="row mt-2" id="botoesDataHora2" style="display: none;">
        <div class="col-auto">
            <button type="button" id="ontem2" class="btn btn-mini btn-outline-secondary" onclick="selecionarData('ontem', 2)">Ontem</button>
        </div>
        <div class="col-auto">
            <button type="button" id="hoje2" class="btn btn-mini btn-outline-secondary" onclick="selecionarData('hoje', 2)">Hoje</button>
        </div>
        <div class="col-auto">
            <button type="button" id="amanha2" class="btn btn-mini btn-outline-secondary" onclick="selecionarData('amanha', 2)">Amanhã</button>
        </div>
        <div class="col-auto">
            <button type="button" id="fixo2" class="btn btn-mini btn-outline-secondary" onclick="mostrarCamposDataHora(2)">Fixo</button>
        </div>
    </div>
    <div class="row mt-2 d-none" id="camposDataHora2">
        <div class="col-auto">
            <input type="date" id="dataFixo2" class="form-control">
        </div>
        <div class="col-auto">
            <input type="time" id="horaFixa2" class="form-control">
        </div>
    </div>
</div>

<div class="mt-3">
    <div class="row g-2 align-items-center">
        <div class="col-auto">
            <select id="selectColuna3" class="form-select" onchange="toggleFiltros(this.value, 3)">
                <option value="">Selecionar...</option>
                @foreach (EnumColunaFiltro coluna in Enum.GetValues(typeof(EnumColunaFiltro)))
                {
                    <option value="@coluna.ToString()">@EnumExtensions.GetDisplayName(coluna)</option>
                }
            </select>
        </div>
        <div class="col-auto">
            <select id="selectNumerico3" class="form-select">
                @foreach (SelectListItem item in ViewBag.CondicaoNumericaOptions)
                {
                    <option value="@item.Value">@item.Text</option>
                }
            </select>
        </div>
        <div class="col-auto">
            <i class="fas fa-trash-alt fa-lg text-black-50" style="cursor: pointer;" onclick="limparFiltros(3)"></i>
        </div>
        <div class="col-12 mt-2">
            <input type="text" id="inputBusca3" class="form-control" style="display: none; width: 30%">
        </div>
    </div>
    <div class="row mt-2" id="botoesDataHora3" style="display: none;">
        <div class="col-auto">
            <button type="button" id="ontem3" class="btn btn-mini btn-outline-secondary" onclick="selecionarData('ontem', 3)">Ontem</button>
        </div>
        <div class="col-auto">
            <button type="button" id="hoje3" class="btn btn-mini btn-outline-secondary" onclick="selecionarData('hoje', 3)">Hoje</button>
        </div>
        <div class="col-auto">
            <button type="button" id="amanha3" class="btn btn-mini btn-outline-secondary" onclick="selecionarData('amanha', 3)">Amanhã</button>
        </div>
        <div class="col-auto">
            <button type="button" id="fixo3" class="btn btn-mini btn-outline-secondary" onclick="mostrarCamposDataHora(3)">Fixo</button>
        </div>
    </div>
    <div class="row mt-2 d-none" id="camposDataHora3">
        <div class="col-auto">
            <input type="date" id="dataFixo3" class="form-control">
        </div>
        <div class="col-auto">
            <input type="time" id="horaFixa3" class="form-control">
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-auto">
            <button type="button" class="btn btn-primary" id="btnFiltrar">Filtrar</button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn btn-secondary" onclick="limparTodosFiltros()">Limpar</button>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="ocorrenciaModal" tabindex="-1" aria-labelledby="ocorrenciaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background-color: orange; padding: 0.5rem; border-bottom: 1px solid orange;">
                <h5 class="modal-title text-white w-100" id="ocorrenciaModalLabel">Ocorrência</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col">
                        <strong>Número:</strong>
                        <div id="modalNumero"></div>
                    </div>
                    <div class="col">
                        <strong>Ocorreu em:</strong>
                        <div id="modalOcorreuEm"></div>
                    </div>
                    <div class="col">
                        <strong>Horário:</strong>
                        <div id="modalHorario"></div>
                    </div>
                    <div class="col">
                        <strong>Lançamento:</strong>
                        <div id="modalLancamento"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <strong>Nº Documento:</strong>
                        <div id="modalDocumento"></div>
                    </div>
                    <div class="col">
                        <strong>Tipo:</strong>
                        <div id="modalTipo"></div>
                    </div>
                    <div class="col">
                        <strong>Pedido:</strong>
                        <div id="modalPedido"></div>
                    </div>
                    <div class="col">
                        <strong>Localização:</strong>
                        <div id="modalLocalizacao"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <strong>Responsável pela Solução:</strong>
                        <div id="modalResponsavelSolucao"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <strong>Transportadora:</strong>
                        <div id="modalTransportadora"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <strong>Interessado:</strong>
                        <div id="modalInteressado"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <strong>Responsável do Interessado:</strong>
                        <div id="modalResponsavelInteressado"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <strong>Origem da Informação:</strong>
                        <div id="modalOrigemInformacao"></div>
                    </div>
                    <div class="col">
                        <strong>Contato:</strong>
                        <div id="modalContato"></div>
                    </div>
                    <div class="col">
                        <strong>RG/CPF:</strong>
                        <div id="modalRgCpf"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <strong>Responsável:</strong>
                        <div id="modalResponsavel"></div>
                    </div>
                    <div class="col">
                        <strong>Departamento Padrão:</strong>
                        <div id="modalDepartamentoPadrao"></div>
                    </div>
                    <div class="col">
                        <strong>Usuário Responsável:</strong>
                        <div id="modalUsuarioResponsavel"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <strong>Cidade de Destino:</strong>
                        <div id="modalCidadeDestino"></div>
                    </div>
                    <div class="col">
                        <strong>Estado Destino:</strong>
                        <div id="modalEstadoDestino"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <strong>Observações:</strong>
                        <div id="modalObservacoes"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <a href="#" id="editarLink" class="text-decoration-none" style="cursor: pointer; color: black;">Editar</a>
                <button type="button" class="btn btn-primary" id="btnSalvar" style="display: none;">Salvar</button>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" />

@section Scripts {
    <script>
        function filtrarOcorrencias() {
            // Criação do objeto DTO com os parâmetros
            var dto = {
                filtros: []
            };

            for (var i = 1; i <= 3; i++) {
                var coluna = $('#selectColuna' + i).val();
                var operador = $('#selectNumerico' + i).val();
                var busca = '';

                if (coluna === 'Solucao_Em' || coluna === 'Ocorreu_Em') {
                    // Se for SolucaoEm ou OcorreuEm, verifica se é data fixa ou outro
                    if ($('#fixo' + i).hasClass('active')) {
                        var dataFixo = $('#dataFixo' + i).val();
                        var horaFixa = $('#horaFixa' + i).val();
                        busca = dataFixo + ' ' + horaFixa;
                    } else {
                        busca = $('#inputBusca' + i).val();
                    }
                } else {
                    // Outros casos apenas pegam o valor do campo inputBusca
                    busca = $('#inputBusca' + i).val();
                }

                // Adiciona ao array de filtros apenas se houver algum valor de busca definido
                if (busca) {
                    var filtro = {
                        coluna: coluna,
                        operador: parseInt(operador), // Converte para inteiro
                        busca: busca
                    };
                    dto.filtros.push(filtro);
                }
            }
            return dto;
        }

        // Evento para acionar a filtragem ao clicar no botão de filtrar
        $('#btnFiltrar').click(function () {
            carregarPagina(1);
        });
        
        // Função para carregar dados de uma página específica
        function carregarPagina(pagina) {
            var dto = filtrarOcorrencias();
            $.ajax({
                url: `/Home/CarregarOcorrencias?pagina=${pagina}`,
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(dto), // Converte o objeto DTO para JSON
                success: function (data) {
                    console.log(data);
                    $('#tabelaOcorrencias tbody').empty();
                    $(data.ocorrencias).each(function (index, ocorrencia) {

                        var joinhaIcon = ocorrencia.jaSolucionada
                            ? '<i class="fas fa-thumbs-up" style="color: green;"></i>'
                            : '<i class="fas fa-thumbs-down" style="color: red;"></i>';

                        var row = `
                                    <tr>
                                        <td><input type="checkbox"></td>
                                        <td>${ocorrencia.id}</td>
                                        <td>${ocorrencia.tipoOcorrencia}</td>
                                        <td>${ocorrencia.ocorreuEm}</td>
                                        <td>${ocorrencia.transportadorDescricao}</td>
                                        <td>${ocorrencia.transportadorCnpj}</td>
                                        <td>${ocorrencia.solucaoEm}</td>
                                        <td>${joinhaIcon}</td>
                                        <td>${ocorrencia.diasEmAberto}</td>
                                                <td><i class="fas fa-exclamation" style="color: black;" onclick="abrirModalOcorrencia(${ocorrencia.id})"></i></td>
                                    </tr>
                                `;
                        $('#tabelaOcorrencias tbody').append(row);
                        // Atualiza a contagem de registros
                        $('#totalRegistros').html(` ${data.totalRegistros} Registros`);
                    });

                    // Atualiza a paginação
                    $('#pagination').empty();

                    var totalPages = data.totalPaginas;
                    var paginaAtual = data.paginaAtual;

                    // Botão "Anterior"
                    var prevPage = paginaAtual - 1;
                    var disabledPrev = paginaAtual === 1 ? "disabled" : "";
                    var linkPrev = `<a class="page-link" href="#" onclick="carregarPagina(${prevPage})">Anterior</a>`;
                    $('#pagination').append(`<li class="page-item ${disabledPrev}">${linkPrev}</li>`);

                    // Páginas anteriores gradualmente
                    var startPage = Math.max(1, paginaAtual - 5); // Mostrar páginas a partir de 1 ou paginaAtual - 5, o que for maior
                    var endPage = Math.min(startPage + 9, totalPages); // Mostrar até 10 páginas no total, começando de startPage

                    for (var i = startPage; i <= endPage; i++) {
                        var liClass = i === paginaAtual ? "page-item active" : "page-item";
                        var link = `<a class="page-link" href="#" onclick="carregarPagina(${i})">${i}</a>`;
                        $('#pagination').append(`<li class="${liClass}">${link}</li>`);
                    }

                    // Botão "Próximo"
                    var nextPage = paginaAtual + 1;
                    var disabledNext = paginaAtual === totalPages ? "disabled" : "";
                    var linkNext = `<a class="page-link" href="#" onclick="carregarPagina(${nextPage})">Próximo</a>`;
                    $('#pagination').append(`<li class="page-item ${disabledNext}">${linkNext}</li>`);

                },
                error: function () {
                    alert("Erro ao carregar dados.");
                }
            });
        }

        function toggleFiltros(valor, filtro) {
            if (valor === 'SolucaoEm' || valor === 'OcorreuEm') {
                $('#botoesDataHora' + filtro).show();
                $('#inputBusca' + filtro).hide();
            } else {
                $('#botoesDataHora' + filtro).hide();
                $('#camposDataHora' + filtro).removeClass('show').addClass('d-none');
                $('#dataFixo' + filtro).val('');
                $('#horaFixa' + filtro).val('');
                $('.btn').removeClass('active'); // Limpa todos os botões ativos
                $('#inputBusca' + filtro).show();
            }
        }

        function selecionarData(opcao, filtro) {
            var hoje = new Date();
            var amanha = new Date();
            amanha.setDate(hoje.getDate() + 1);
            var ontem = new Date();
            ontem.setDate(hoje.getDate() - 1);

            var dataSelecionada;
            switch (opcao) {
                case 'hoje':
                    dataSelecionada = hoje;
                    break;
                case 'amanha':
                    dataSelecionada = amanha;
                    break;
                case 'ontem':
                    dataSelecionada = ontem;
                    break;
                default:
                    break;
            }

            var dataFormatada = dataSelecionada.toISOString().slice(0, 10);
            var horaFormatada = dataSelecionada.toISOString().slice(11, 16);

            $('#inputBusca'+ filtro).val(dataFormatada);
            $('#camposDataHora' + filtro).removeClass('show').addClass('d-none');
            $('#dataFixo'+ filtro).val('');
            $('#horaFixa' + filtro).val('');

            // Remover a classe 'active' de todos os botões e adicionar ao botão selecionado
            $('#botoesDataHora' + filtro + ' .btn').removeClass('active')
                .css({ 'color': 'black', 'background-color': 'transparent' });
            $('#' + opcao + filtro).addClass('active').css({ 'color': 'white', 'background-color': '#007bff' });
        }

        function mostrarCamposDataHora(filtro) {
            $('#camposDataHora' + filtro).removeClass('d-none').addClass('show');

            // Remover a classe 'active' de todos os botões e adicionar ao botão selecionado
            $('#botoesDataHora' + filtro + ' .btn')
                .removeClass('active').css({ 'color': 'black', 'background-color': 'transparent' });
            $('#fixo' + filtro).addClass('active').css({ 'color': 'white', 'background-color': '#007bff' });
        }

        function limparFiltros(filtro) {
            $('#selectColuna' + filtro).val('');
            $('#selectNumerico' + filtro).val('0');
            $('#inputBusca' + filtro).val('').hide();
            $('#botoesDataHora ' + filtro +'.btn')
                .removeClass('active').css({ 'color': 'black', 'border-color': 'black', 'background-color': 'transparent' });
            $('#botoesDataHora' + filtro).hide();
            $('#camposDataHora' + filtro).removeClass('show').addClass('d-none');
            $('#dataFixo' + filtro).val('');
            $('#horaFixa' + filtro).val('');
        }

        function abrirModalOcorrencia(idOcorrencia) {
            $.ajax({
                url: `/Home/Detalhes?idOcorrencia=${idOcorrencia}`,
                type: 'GET',
                success: function (ocorrencia) {
                    // Preenche os campos da modal
                    $('#modalNumero').text(ocorrencia.numero);
                    $('#modalOcorreuEm').text(ocorrencia.ocorreuEm);
                    $('#modalHorario').text(ocorrencia.horario);
                    $('#modalLancamento').text(ocorrencia.lancamento);
                    $('#modalDocumento').text(ocorrencia.documento);
                    $('#modalTipo').text(ocorrencia.tipoDescricao);
                    $('#modalPedido').text(ocorrencia.pedido);
                    $('#modalLocalizacao').text(ocorrencia.localizacao);
                    $('#modalResponsavelSolucao').text(ocorrencia.responsavelSolucao);
                    $('#modalTransportadora').text(ocorrencia.transportadoraDescricao);
                    $('#modalInteressado').text(ocorrencia.interessado);
                    $('#modalResponsavelInteressado').text(ocorrencia.responsavelInteressado);
                    $('#modalOrigemInformacao').text(ocorrencia.origemInformacao);
                    $('#modalContato').text(ocorrencia.contato);
                    $('#modalRgCpf').text(ocorrencia.rgCpf);
                    $('#modalResponsavel').text(ocorrencia.responsavel);
                    $('#modalDepartamentoPadrao').text(ocorrencia.departamentoPadrao);
                    $('#modalUsuarioResponsavel').text(ocorrencia.usuarioResponsavel);
                    $('#modalCidadeDestino').text(ocorrencia.cidadeDestino);
                    $('#modalEstadoDestino').text(ocorrencia.estadoDestino);
                    $('#modalObservacoes').text(ocorrencia.observacoes);

                    // Habilita a edição
                    $('#editarLink').off('click').click(function () {
                        habilitarEdicao();
                    });

                    $('#ocorrenciaModal').modal('show');
                },
                error: function (xhr, status, error) {
                    // Handle error
                    console.error('Erro ao buscar detalhes da ocorrência:', error);
                    alert('Erro ao buscar detalhes da ocorrência');
                }
            });
        }

        function habilitarEdicao() {
            // Transforma os campos da modal em editáveis
            const camposEditaveis = [
                'modalNumero',
                'modalOcorreuEm',
                'modalHorario',
                'modalLancamento',
                'modalDocumento',
                'modalTipo',
                'modalPedido',
                'modalLocalizacao',
                'modalResponsavelSolucao',
                'modalTransportadora',
                'modalInteressado',
                'modalResponsavelInteressado',
                'modalOrigemInformacao',
                'modalContato',
                'modalRgCpf',
                'modalResponsavel',
                'modalDepartamentoPadrao',
                'modalUsuarioResponsavel',
                'modalCidadeDestino',
                'modalEstadoDestino',
                'modalObservacoes'
            ];

            camposEditaveis.forEach(campo => {
                const valorAtual = document.getElementById(campo).innerText;
                document.getElementById(campo)
                    .innerHTML = `<input id="${campo}"type="text" class="form-control" value="${valorAtual}">`;
            });

            $('#btnSalvar').show();
        }

        // Função para limpar todos os filtros
        function limparTodosFiltros() {
            for (var i = 1; i <= 3; i++) {
                limparFiltros(i);
            }
            carregarPagina(1); // Recarrega a primeira página sem filtros
        }

        // Carrega a primeira página ao carregar a página inicialmente
        $(document).ready(function () {
            carregarPagina(1);
        });
    </script>
}